<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no,target-densitydpi=device-densitydpi" />
    <title>个人中心</title>
    <link rel="stylesheet" href="css/common.css">

    <script type="text/javascript" src="js/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="js/self-menu.js"></script>

    <script src="./js/pageCommon.js"></script>
    <script type="text/javascript" src="js/quo.js"></script>
    <script src="./js/common.js"></script>
    <script src="./js/jquery-jtemplates.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=1.4"></script>
</head>
<style>

</style>
<script>

    var optionDom;
    $(function(){
        if(!localStorage.userinfo){
            window.location.href = "bind-mine.html";
        }
        var userInfo = JSON.parse(localStorage.userinfo);
        /*页面加载时创建一次jtemplate模板，此后都是给模板赋值*/
        (function createTemplate(){
            // 附上模板
            $("#favoritelist").setTemplateElement("template");

        })();
        var userPosition ;
        if(localStorage.userPosition){
            userPosition = localStorage.userPosition;
            /*接口调用*/
            po('user','getfavoritelist',{"UserID":userInfo.UserID,"UserPosition":userPosition,"PrdID":""},"getfavoritelistcallback");
        }else{
            /*获取位置信息*/
            var geolocation = new BMap.Geolocation();
            var userPosition = "116.404|39.915";
            geolocation.getCurrentPosition(function(r){
                if(this.getStatus() == BMAP_STATUS_SUCCESS){
                    //alert('您的位置：'+r.point.lng+','+r.point.lat);
                    userPosition = r.point.lng+"|"+r.point.lat;
                    localStorage.UserPosition = userPosition;
                }
                else {
                    if(localStorage.userPosition){
                        userPosition = "116.404|39.915";
                    }
                }
                /*接口调用*/
                po('user','getfavoritelist',{"UserID":userInfo.UserID,"UserPosition":userPosition,"PrdID":""},"getfavoritelistcallback");
            },{enableHighAccuracy: true});
        }

        /*长按事件*/
        $$(document).on("hold","#favoritelist>li",function(){
            //TODO弹出框是否确定删除
            optionDom = $$(this);
            var choose = confirm("确定要删除？");
            //根据返回结果判断：否不操作，是则删除
            if(choose){
                var act="cancel";
                var prdid = $$(this).attr("prd");
                //alert(prdid);
                var data={
                    "PrdID":prdid,
                    "UserID":userInfo.UserID,
                    "Act": act
                };
                po('product','favorite',data,"getfavoritecallback");

            }
        });

    });
    /*关注和取消的回调函数*/
    function getfavoritecallback(d){
        //alert(JSON.stringify(d))
        /*d.rd.succ = true;*/
        if(d.rd.succ){
            optionDom.remove();
        }else{
            alert(d.rd.msg);
        }
    }
    //获取收藏列表回调函数
    function getfavoritelistcallback(d){
      //  alert(JSON.stringify(d));
       /* d.rd.succ=true;*/
        if(d.rd.succ){

            var fl = d.rd.data.favoritelist;

            for(var j = 0;j<fl.length;j++){
                //判断商家是否已认证，并将json改为相应的class
                if(!fl[j]["MakeDate"]){
                    fl[j]["MakeDate"]="--";
                }
                if(!fl[j]["R3"]){
                    fl[j]["R3"]="--";
                }
                if(!fl[j]["R4"]){
                    fl[j]["R4"]="--";
                }
               /* if(fl[j]["PrdName"].length>5){
                    fl[j]["PrdName"] = fl[j]["PrdName"].substr(0,4)+"...";
                }*/
            }
            //以下采用jtemplates的方式进行模板的拼接
            // 给模板加载数据
            $("#favoritelist").processTemplate(fl);	/*d.rd.data.sellerlist*/
        }else{
            alert(d.rd.msg);
        }
    }
</script>
<body>

<header>
    个人中心
</header>
<div class="self-menu">
    <div id="menu" class="menu" style="left: -70%">
        <ul>
            <li class="first-item " style="margin-left: 1%"><a href="selfzoom.html">我的中心</a></li>
            <li><a href="my-info.html">个人信息</a></li>
            <li class="right-border0" style="margin-right: 1%"><a href="myOrderList.html">订单信息</a></li>
            <li class="margin-left" style="margin-left: 1%"><a href="myactivity.html">我的活动</a></li>
            <li class="selected"><a href="#">我的收藏</a></li>
            <li class="right-border0" style="margin-right: 1%"><a href="mylike.html">我的关注</a></li>
        </ul>
    </div>
    <div class="move-left" id="moveleft"><a ></a></div>
    <div class="move-right" id="moveright"><a ></a></div>
</div>
<main class="mysave">
    <ul id="favoritelist">
        <textarea id="template" style="display:none">
            {#foreach $T as record}
        <li class="odd-item" prd="{$T.record.PrdID}">
            <span>
                <a href="good-info.html?id={$T.record.PrdID}" style="border-radius: 50%;background: url('img/prd.jpg');background-position: center;background-size: cover">
                    <!--<img width="100%" src="img/save-good.png">-->
                    <div class="info" style="border-radius: 50%">
                        <span class="info-txt">
                        <h1 class="title">{$T.record.PrdName}</h1>
                        <h4 class="content1">发布时间：{$T.record.MakeDate}</h4>
                        <h4 class="content2">浏览次数：{$T.record.R3}</h4>
                        <h4 class="content3">预订数：{$T.record.R4}</h4>
                    </span>
                    </div>
                </a>
            </span>
        </li>
            {#/for}
        </textarea>
    </ul>
</main>
<footer>
    <ul>
        <li class="side-item"></li>
        <li>
            <a  href="activities.html">
                <span class="button-icon activity-icon"></span>
            </a>
        </li>
        <li>
            <a  href="busines.html">
                <span class="button-icon business-icon"></span>
            </a>
        </li>
        <li>
            <a class="selected"  href="selfzoom.html">
                <span class="button-icon selfzoom-icon"></span>
            </a>
        </li>
        <li class="side-item"></li>
    </ul>
</footer>

<script>

    $(function () {
        $(window).scroll(function () {
            $("footer").animate({bottom: "0"}, "fast");
        });
    });
</script>
</body>
</html>