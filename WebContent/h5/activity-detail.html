<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no,target-densitydpi=device-densitydpi" />
    <title>活动详情</title>
    <link rel="stylesheet" href="css/common.css">
    <script type="text/javascript" src="js/jquery-1.11.1.min.js"></script>
    <script src="./js/common.js"></script>
    <script src="./js/jquery-jtemplates.js"></script>
    <script src="./js/pageCommon.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=1.4"></script>
</head>
<style>

</style>
<script>
    var userInfo;
    var userPosition;
    var  actInfo;
    $(function(){
        actInfo= JSON.parse("{}")
        var actId;
        if(getParameter("id") && getParameter("id")!=""){
            actId = getParameter("id");
            actInfo.ActID = actId;
            localStorage.actInfo = JSON.stringify(actInfo) ;
            //alert(localStorage.actInfo);
        }else{
            window.location.href="activities.html";
        }
        if(!localStorage.userinfo){
            window.location.href="bind-mine.html";
        }
        userInfo = JSON.parse(localStorage.userinfo);
        // 附上模板
        $("#result1").setTemplateElement("template");
        var userPosition ;
        if(localStorage.userPosition){
            userPosition = localStorage.userPosition;
            /*接口调用*/
            po('activity','getact',{"ActID":actInfo.ActID,"UserPosition":userPosition,"UserID":userInfo.UserID},"getactcallback");
        }else{
            /*获取位置信息*/
            var geolocation = new BMap.Geolocation();
            var userPosition = "116.404|39.915";
            geolocation.getCurrentPosition(function(r){
                if(this.getStatus() == BMAP_STATUS_SUCCESS){
                    //alert('您的位置：'+r.point.lng+','+r.point.lat);
                    userPosition = r.point.lng+"|"+r.point.lat;
                    localStorage.UserPosition = userPosition;
                }
                else {
                    if(localStorage.userPosition){
                        userPosition = "116.404|39.915";
                    }
                }
                /*接口调用*/
                po('activity','getact',{"ActID":actInfo.ActID,"UserPosition":userPosition,"UserID":userInfo.UserID},"getactcallback");
            },{enableHighAccuracy: true});
        }




        /*收藏和取消的按钮*/
        $(document).on("click","#save-act",function(){
            var act=$(this).attr("act");
            var data={
                "PrdID":actInfo.ActID,
                "UserID":userInfo.UserID,
                "Act": act
            };
//            alert(prdInfo.PrdID+"  "+userInfo.UserID)
            po('product','favorite',data,"getfavoritecallback");
        });

        /*报名和取消报名的按钮*/
        $(document).on("click","#joininli",function(){
            var act=$(this).attr("act");
            var data={
                "ActID":actInfo.ActID,
                "UserID":userInfo.UserID,
                "Act": act
            };
            po('activity','register',data,"getregistercallback");
        });
    });
    

    /*收藏和取消的回调函数*/
    function getfavoritecallback(d){
        //alert(JSON.stringify(d))

        if(d.rd.succ){
            alertMsg("#save-act",d.rd.msg,"10%","-100%","#364e86","2em","110%");
            //将图标切换关注
            if($("#save-act").attr("act")=="add"){
                $("#save-act").removeClass("add-save");
                $("#save-act").addClass("cancel-save");
                $("#save-act").attr("act","cancel")
            }else{
                $("#save-act").removeClass("cancel-save");
                $("#save-act").addClass("add-save");
                $("#save-act").attr("act","add")
            }

        }else{
            alert(d.rd.msg);
        }
    }
    /*参加和取消的回调函数*/
    function getregistercallback(d){
        if(d.rd.succ){
            //将图标切换参加
            if($("#joinin").attr("act")=="add"){
                $("#joinin").find("span").eq(0).removeClass("add-icon");
                $("#joinin").find("span").eq(0).addClass("cancel-icon");
                $("#joinin").find("span").eq(1).html("取消报名");
                $("#joinin").attr("act","cancel");
            }else{
                $("#joinin").find("span").eq(0).removeClass("cancel-icon");
                $("#joinin").find("span").eq(0).addClass("add-icon");
                $("#joinin").find("span").eq(1).html("我要参加");
                $("#joinin").attr("act","add");
            }
            setTimeout(function(){
                po('activity','getact',{"ActID":actInfo.ActID,"UserPosition":userPosition,"UserID":userInfo.UserID},"getactcallback");
            },1700);
            alertMsg("#joinin",d.rd.msg,"50%","0","#000000","0.8em","8%");
        }else{
            alertMsg("#joinin",d.rd.msg,"50%","0","#000000","0.8em","8%");
        }
    }

    /*获取活动信息的回调函数*/
    function getactcallback(d)
    {
        console.dir(d);
        if(d.rd.succ)
        {
            if(d.rd.data.ConnStatus=="y"){
                d.rd.data.ConnStatus="cancel-icon";
                d.rd.data.ConnStatusMsg = "取消报名";
                d.rd.data.ConnStatusAct = "cancel";
            }else{
                //alert(1)
                d.rd.data.ConnStatus="add-icon";
                d.rd.data.ConnStatusMsg = "我要参加";
                d.rd.data.ConnStatusAct = "add";

            }
            //各种判断
            if(!d.rd.data.RegEndDate.trim()){
                d.rd.data.RegEndDate = "xxxx-xx-xx"
            }
            var datearr =  d.rd.data.RegEndDate.split("-")
            d.rd.data.RegEndDate = datearr[0]+"年"+datearr[1]+"月"+datearr[2]+"日";
            if(d.rd.data.Sataus=="y"){
                d.rd.data.canjoin="";
                d.rd.data.finished="status-Grey";
                d.rd.data.footCss = "";
            }else{
                d.rd.data.canjoin="status-Grey";
                d.rd.data.finished="";
                d.rd.data.footCss = "display:none";
            }
            //保存到本地缓存
            localStorage.actInfo = JSON.stringify(d.rd.data);
            //alert(localStorage.sellerInfo );
//            alert(getParameter("followed"));
            if(getParameter("followed")=="y"){
                d.rd.data.visibility = "visible";
            }else{
                d.rd.data.visibility = "hidden";
            }
            // 给模板加载数据
            $("#result1").processTemplate(d.rd.data);	/*d.rd.data.sellerlist*/
        }
    }
    function atn(){
//alert();
    }
</script>
<body id="result1">
<textarea id="template" style="display:none">
<header>
    <div class="select-back">
        <a href="javascript:history.go(-1)">
            <span  class="back-icon"></span><br>
            返回
        </a>
    </div>
    活动详情
    <div class="speak" id="speak" style="visibility:{$T.visibility};">
        <a href="speak2.html">
            <span  class="speak-icon"></span>
        </a>
    </div>
</header>
<main class="activity-detail">
    <div class="imgad">
        <img src="img/acitvity.png" width="100%">
    </div>
    <div class="detail ">
        <div class="first-info-item bolderFont">
            <div class="left-content">
                <span class="title">活动标题</span>
                <span class="txt" id="OrgBiref">
                    {$T.Title}
                </span>

            </div>
            <div class="right-btn">
                <a id="save-act" class="attention-icon attention" style="display: none"   act="add"></a>
            </div>
        </div>
        <div class="info-item  bolderFont">
            <span class="title">地点</span>
            <span class="txt">{$T.R4}</span>
        </div>
        <div class="info-item   bolderFont">
            <span class="title">发起团体</span>
            <span class="txt">{$T.ShotOrgName}</span>
        </div>
        <div class="info-item ">

            <span class="title ">活动开始时间</span>
            <span class="txt" style="padding-left: 6.5em">
                <span style="white-space: nowrap;">{$T.StartDate}</span>
                <span style="white-space: nowrap;">{$T.StartTime}</span>
            </span>
        </div>
        <div class="info-item ">
            <span class="title ">活动结束时间</span>
            <span class="txt" style="padding-left: 6.5em">
                <span style="white-space: nowrap;">{$T.EndDate}</span>
                <span style="white-space: nowrap;">{$T.EndTime}</span>
            </span>
        </div>
        <div class="info-item ">
            <span class="title ">报名截止日期</span>
            <span class="txt" style="padding-left: 6.5em">{$T.RegEndDate}</span>
        </div>
        <div class="info-item ">
            <span class="title ">计划人数</span>
            <span class="txt">{$T.AcPeople}</span>
        </div>

        <div class="info-item  ">
            <span class="title">联系人电话</span>
            <span class="txt">{$T.Phone}</span>
        </div>
        <div class="info-item  ">
            <span class="title">缴纳费用</span>
            <span class="txt">{$T.ActFee}</span>
        </div>
        <div class="info-item  ">
            <span class="title">奖品赠品</span>
            <span class="txt">{$T.ActGift}</span>
        </div>
        <div class="info-item">
            <span class="title">活动内容</span>
            <span class="txt" style="padding-bottom: 0.75em">{$T.ActContent}
            </span>
        </div>
        <div class="info-item  ">
            <span class="title">参加人数</span>
            <span class="txt" id="PtcNum">{$T.PtcNum}</span>
        </div>
        <div class="info-item   ">
            <span class="title">报名状态</span>
            <span class="txt">
                <span class="margin-rightNon margin-right1em {$T.canjoin}" >报名中</span>
                \
                <span class="margin-rightNon margin-left1em {$T.finished}" >已结束</span>
            </span>
        </div>
    </div>

    <div onclick="atn();" class="foot" style="{$T.footCss}" id="joininli" style="z-index:999999;">
       <ul>
           <li style="width:100%">
               <a id="joinin" act="{$T.ConnStatusAct}">
                   <div>
                       <span class="{$T.ConnStatus}" ></span>
                       <span>{$T.ConnStatusMsg}</span>
                   </div>
               </a>
           </li>
           <!-- <li><a href="conn-initiator.html"><span class=" talk-icon"></span><span>与创建人聊天</span></a></li> -->
       </ul>
    </div>
    <br/><br/><br/><br/>
</main>
    </textarea>
</body>
</html>