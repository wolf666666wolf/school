<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no,target-densitydpi=device-densitydpi" />
    <title>我有话说</title>
    <link rel="stylesheet" href="css/common.css">
    <script type="text/javascript" src="js/jquery-1.11.1.min.js"></script>
    <script src="./js/pageCommon.js"></script>
    <script src="./js/common.js"></script>
    <script src="./js/jquery-jtemplates.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=1.4"></script>
</head>
<style>

</style>
<script>
    $(function(){
        // alert(localStorage.userinfo);
        //页面加载的一些处理
//        alert(getParameter("id"))
        if(localStorage.userinfo==undefined){
            window.location.href = "bind-mine.html";
        }
        var userInfo = JSON.parse(localStorage.userinfo);
        if(! localStorage.sellerInfo ){
            window.location.href = "view-shop.html";
        }
        //alert(localStorage.sellerInfo)
		
        sellerInfo = JSON.parse(localStorage.sellerInfo);
        /*页面赋值*/
        $("#back").attr("href","view-shop.html?id="+sellerInfo.SellerID);
        $("#SellerID").html(sellerInfo.SellerID);
        $("#SellerName").html(sellerInfo.SellerName);
        $("#AuthFlag").html(sellerInfo.AuthFlag);

        /*等级：R4*/
        var rank = 0;
        if(sellerInfo.R6){
            rank = sellerInfo.R6;
        }
        showLevel(rank);
        function showLevel(rank){
            for(var i=1;i<=5;i++){
                if(rank-i>=0){
                    $("#starList").find("li").eq(i-1).attr("class","full-icon");
                }
                if(rank-i==-0.5){
                    $("#starList").find("li").eq(i-1).attr("class","half-icon");
                }
                if(rank-i<=-1){
                    $("#starList").find("li").eq(i-1).attr("class","blank-icon");
                }
            }
        }


        var userPosition ;
        if(localStorage.userPosition){
            userPosition = localStorage.userPosition;
            /*表单提交*/
            $("#sendMessage").click(function() {
                if($("#Context").val()==""){alert("留言内容不能为空");return;}
                var level = getlevel();
                var connnumber = $("#Phone").val().trim();
                var length = connnumber.length;
                var mobile = /^(((13[0-9]{1})|(15[0-9]{1})|(18[0-9]{1}))+\d{8})$/;
                var tel = /^(([0\+]\d{2,3}-)?(0\d{2,3})-)(\d{7,8})(-(\d{3,}))?$/;
                connnumber = connnumber.trim();
                if(tel.test(connnumber) && !mobile.test(connnumber)) {
                    alert("请输入正确联系方式！");
                    return;
                }
                var data = {
                    "UserPosition":userPosition,//用户位置
                    "SellerID":sellerInfo.SellerID,//商家编码
                    "UserID": userInfo.UserID,//用户编码
                    "Level": level,//等级，数字1到5
                    "Context": $("#Context").val(),//内容
                    "Phone": $("#Phone").val(),//电话
                    "OrderID":""
                };
                //alert(JSON.stringify(data))；
                po("seller","message",data,"messagecallback");
                $(this).attr("disabled",true);
            });
        }else{
            /*获取位置信息*/
            var geolocation = new BMap.Geolocation();
            var userPosition = "116.404|39.915";
            geolocation.getCurrentPosition(function(r){
                if(this.getStatus() == BMAP_STATUS_SUCCESS){
                    //alert('您的位置：'+r.point.lng+','+r.point.lat);
                    userPosition = r.point.lng+"|"+r.point.lat;
                    localStorage.UserPosition = userPosition;
                }
                else {
                    if(localStorage.userPosition){
                        userPosition = "116.404|39.915";
                    }
                }
                /*表单提交*/
                $("#sendMessage").click(function() {
                    if($("#Context").val()==""){alert("留言内容不能为空");return;}
                    var level = getlevel();
                    var connnumber = $("#Phone").val().trim();
                    var length = connnumber.length;
                    var mobile = /^(((13[0-9]{1})|(15[0-9]{1})|(18[0-9]{1}))+\d{8})$/;
                    var tel = /^(([0\+]\d{2,3}-)?(0\d{2,3})-)(\d{7,8})(-(\d{3,}))?$/;
                    connnumber = connnumber.trim();
                    if(tel.test(connnumber) && !mobile.test(connnumber)) {
                        alert("请输入正确联系方式！");
                        return;
                    }
                    var data = {
                        "UserPosition":userPosition,//用户位置
                        "SellerID":sellerInfo.SellerID,//商家编码
                        "UserID": userInfo.UserID,//用户编码
                        "Level": level,//等级，数字1到5
                        "Context": $("#Context").val(),//内容
                        "Phone": $("#Phone").val(),//电话
                        "OrderID":""
                    };
                    //alert(JSON.stringify(data))；
                    po("seller","message",data,"messagecallback");
                    $(this).attr("disabled",true);
                });
            },{enableHighAccuracy: true});
        }




        function getlevel(){
            var level = 0;
            $("#starList").find("li").each(function(){
//                alert($(this).attr("class"))
                var num = 0;
                if($(this).attr("class")=="full-icon"){
                    num=1;
                }
                if($(this).attr("class")=="half-icon"){
                    num = 0.5;
                }
                if($(this).attr("class")=="blank-icon"){
                    num = 0;
                }
                level = level + num;
            });
            return level;
        }

        /*商家星级评价*/

        $("#starList").find("li").click(function(){
            //alert(rank)
            var thisclass = $(this).attr("class");
            //alert(thisclass)
            $("#starList").find("li").each(function(){
                $(this).attr("class","blank-icon")
            });
            var userMark = $("#starList").find("li").index($(this));
            for(var i = 0;i<userMark;i++){
                $("#starList").find("li").eq(i).attr("class","full-icon");
            }
            if(thisclass=="blank-icon"){
                $(this).attr("class","half-icon");
            }
            if(thisclass=="half-icon"){
                $(this).attr("class","full-icon");
            }
            if(thisclass=="full-icon"){
                $(this).attr("class","blank-icon");
            }
        });

    });

    /*提交评价的回调函数*/
    function messagecallback(d){
        //alert(JSON.stringify(d))
        if(d.rd.succ){
//        alert(d.rd.msg)
            alertMsg("main",d.rd.msg,"50%","0%","#374F87","0.8em","15%");
            $("#sendMessage").attr("disabled",false);
            setTimeout(function(){
                window.location.href="view-shop.html";
            },1700);

        }else{
            alertMsg("main",d.rd.msg,"50%","0%","#374F87","0.8em","10%");
            $("#sendMessage").attr("disabled",false);
        }
    }

</script>
<body>
<div class="container"></div>
<header>
    <div class="select-back">
        <a href="" id="back">
            <span  class="back-icon"></span><br>
            返回
        </a>
    </div>
    我有话说
</header>
<main class="leave-message">
    <div class="item border-bottom">
        <span class="leftsp">商户编号</span>
        <span class="rightsp" id="SellerID">xxxxxxxxxx</span>
    </div>
    <div class="item border-bottom">
        <span class="leftsp">商户名称</span>
        <span class="rightsp" id="SellerName">xxxxxxxx</span>
    </div>
    <div class="item border-bottom">
        <span class="leftsp">评价星级</span>
        <span class="rightsp">
             <div class="star-list">
                 <ul id="starList">
                     <li class="full-icon"></li>
                     <li class="full-icon"></li>
                     <li class="full-icon"></li>
                     <li class="half-icon"></li>
                     <li class="blank-icon"></li>
                 </ul>
             </div>
        </span>

    </div>
    <div class="item border-bottom">
        <span class="leftsp">商户类型</span>
        <span class="rightsp" id="AuthFlag">xxx</span>
    </div>
    <form action="" method="">
    <div class="item">
        <span class="leftsp">我的电话</span>
    </div>
    <input id="Phone" type="text"  placeholder="+86">
    <div class="item"><span class="leftsp">留言</span></div>
    <textarea id="Context"></textarea>

    <a id="sendMessage" class="sendmsg-icon"></a>
    </form>
</main>



</body>
</html>