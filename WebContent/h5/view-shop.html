<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no,target-densitydpi=device-densitydpi" />
    <title>店铺详情</title>
    <link rel="stylesheet" href="css/common.css">

    <script type="text/javascript" src="js/jquery-1.11.1.min.js"></script>
    <script src="./js/common.js"></script>
    <script src="./js/jquery-jtemplates.js"></script>
    <script src="./js/pageCommon.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=1.4"></script>
    <script type="text/javascript" src="js/quo.js"></script>
</head>
<script>

    $(function(){
        //页面加载的一些处理
        var sellerInfo = JSON.parse("{}")
        var sellerId;
        if(!localStorage.userinfo){
            window.location.href="bind-mine.html";
        }
        var userInfo = JSON.parse(localStorage.userinfo);

        if(getParameter("id") && getParameter("id")!=""){
            sellerId = getParameter("id");
            sellerInfo.SellerID = sellerId;
            localStorage.sellerInfo = JSON.stringify(sellerInfo) ;
        }else  if(localStorage.sellerInfo){
            sellerInfo = JSON.parse(localStorage.sellerInfo);
        }else{
            window.location.href("busines.html");
        }
        var userPosition ;
        if(localStorage.userPosition){
            userPosition = localStorage.userPosition;
            /*接口调用*/
            po('seller','getseller',{"SellerID":sellerInfo.SellerID,"UserPosition":userPosition,"UserID":userInfo.UserID},"getsellercallback");
        }else{
            /*获取位置信息*/
            var geolocation = new BMap.Geolocation();
            var userPosition = "116.404|39.915";
            geolocation.getCurrentPosition(function(r){
                if(this.getStatus() == BMAP_STATUS_SUCCESS){
                    //alert('您的位置：'+r.point.lng+','+r.point.lat);
                    userPosition = r.point.lng+"|"+r.point.lat;
                    localStorage.UserPosition = userPosition;
                }
                else {
                    if(localStorage.userPosition){
                        userPosition = "116.404|39.915";
                    }
                }
                po('seller','getseller',{"SellerID":sellerInfo.SellerID,"UserPosition":userPosition,"UserID":userInfo.UserID},"getsellercallback");
            },{enableHighAccuracy: true});
        }


        /*关注和取消关注的按钮*/
        $(document).on("click","#attention",function(){
            var act=$(this).attr("act");
            var data={
                "SellerID":sellerInfo.SellerID,
                "UserID":userInfo.UserID,
                "Act": act
            };
            po('seller','follow',data,"getattentioncallback");
        });

    });

    /*关注和取消的回调函数*/
    function getattentioncallback(d){
        //alert(JSON.stringify(d))
        if(d.rd.succ){
            alertMsg("#attention",d.rd.msg,"10%","-100%","#ffffff","0.8em","150%");
            //将图标切换关注
            if($("#attention").attr("act")=="add"){
                $("#attention").removeClass("attention");
                $("#attention").addClass("cancel-attention");
                $("#attention").attr("act","cancel")
            }else{
                $("#attention").removeClass("cancel-attention");
                $("#attention").addClass("attention");
                $("#attention").attr("act","add")
            }

        }else{
            alert(d.rd.msg);
        }
    }



    /*获取商家信息的回调函数*/
    function getsellercallback(d)
    {
       //alert(JSON.stringify(d))
        if(d.rd.succ)
        {

            //alert(d.rd.data.OrgBrief);
            if(d.rd.data.AuthFlag=="Y"){
                d.rd.data.AuthFlag="已认证";
            }else{
                d.rd.data.AuthFlag="未认证";
            }
            if(d.rd.data.ConnStatus=="Y"){
                $("#attention").removeClass("attention");
                $("#attention").addClass("cancel-attention");
                $("#attention").attr("act","cancel")
            }
            if(d.rd.data.ConnStatus=="n"){
                $("#attention").removeClass("cancel-attention");
                $("#attention").addClass("attention");
                $("#attention").attr("act","add")
            }
            var level = d.rd.data.R6;
            var stararr = [];
            for(j=1;j<=5;j++){
                if(level-j>=0){
                    stararr.push({"starType":"full-icon"});
                }
                if(level-j==-0.5){
                    stararr.push({"starType":"half-icon"})
                }
                if(level-j<=-1){
                    stararr.push({"starType":"blank-icon"})
                }
            }
            d.rd.data.SellerID = d.data.SellerID;
			
            d.rd.data.stararr = stararr;
            //保存到本地缓存
            localStorage.sellerInfo = JSON.stringify(d.rd.data);
            /*给页面元素赋值*/
            if(!d.rd.data.XY){
                d.rd.data.XY = localStorage.userPosition;
            }
            //alert(d.rd.data.XY)
            var sellerX = d.rd.data.XY.split("|")[0];
            var sellerY = d.rd.data.XY.split("|")[1];
            //alert(sellerX +"  "+sellerY);
            $("#SellerName").html (d.rd.data.ShotOrgName);//商家名称
            var imgsrc = d.rd.data.PicUrl+"?"+new Date().getTime();
            $("#PicUrl").attr("src",imgsrc);//图片地址

            $("#TelPhone").html ("<a href='tel:"+d.rd.data.TelPhone+"'>"+d.rd.data.TelPhone+"</a>");//咨询电话
            $("#AuthFlag").html (d.rd.data.AuthFlag);//咨询电话
            $("#OrgBiref").html (d.rd.data.OrgBrief);//商户简介
            for(var m =0;m< d.rd.data.stararr.length;m++){
                $("#starList").find("li").eq(m).attr("class",d.rd.data.stararr[m]["starType"]);
            }
            $("#Address").html(d.rd.data.Address);//地址
            $("#Address").attr({"sellerX":sellerX,"sellerY":sellerY});
            createMap();
        }
    }

</script>
<style>
#TelPhone a{ color:#ffffff;}
</style>
<body class="view-shop-mask" id="result1">
<!--<textarea id="template" style="display:none">-->
<header id="title">
    <div class="select-back">
        <a href="busines.html">
            <span  class="back-icon"></span><br>
            返回
        </a>
    </div>
    <span id="SellerName"> 商户名称</span>
    <div class="speak">
        <a href="leave-message.html" id="leaveMsg">
            <span  class="speak-icon"></span>
        </a>
    </div>
</header>
<div class="shop-menu">
    <ul>
        <li class="selected" >
            <a href="#">详细信息</a>
        </li>
        <li>
            <a href="view-goods.html">商品列表</a>
        </li>
    </ul>
</div>
<main class="view-shop-mask" >


            <img src="img/store.png" id="PicUrl" width="100%" onerror= "javascript:this.src='img/store.png' " >


        <div class="detail">
            <div class="first-info-item">
                <div class="left-content">
                    <span class="title">商户简介</span>
                <span class="txt" id="OrgBiref">
                    ----
                </span>

                </div>
                <div class="right-btn">
                    <a id="attention" class="attention-icon attention"  act="add"></a>
                </div>
            </div>
            <div class="info-item h3em">
                <span class="title">咨询电话</span>
                <span class="txt" id="TelPhone"></span>
            </div>
            <div class="info-item h3em">
                <span class="title">用户类型</span>
                <span class="txt" id="AuthFlag"></span>
            </div>
            <div class="info-item h3em">
                <span class="title">评级</span>
            <span class="txt">
                <div class="star-list">
                    <ul id="starList">
                        <li id="star1" class="{$T.stars.starType}"></li>
                        <li id="star2" class="{$T.stars.starType}"></li>
                        <li id="star3" class="{$T.stars.starType}"></li>
                        <li id="star4" class="{$T.stars.starType}"></li>
                        <li id="star5" class="{$T.stars.starType}"></li>
                    </ul>
                </div>
            </span>


            </div>
            <div class="info-item">
                <span class="title">地址</span>
            <span class="txt font20" id="Address">
            </span>
                <div id="bd_map" style="width: 100%;height:0;padding-top: 30%;padding-bottom:30%;margin-bottom: 50px;" class="address-img">

                </div>
                <!--<span class="title">二维码</span>

                <img class="tdcode-img" src="img/2d-code.png" width="50%">-->
            </div>
        </div>


</main>
<!--</textarea>-->

<script>
    //页面上添加地图

        function createMap(){
            var map = new BMap.Map("bd_map");
            map.enableScrollWheelZoom();
            //alert($("#Address").attr("sellerX") +" " + $("#Address").attr("sellerY"));
            var point = new BMap.Point($("#Address").attr("sellerX"),$("#Address").attr("sellerY")); // 经纬度显示商户位置
            map.centerAndZoom(point,20);
            var marker = new BMap.Marker(point);// 创建标注
            map.addOverlay(marker);// 将标注添加到地图中

//        var pointSeller = new BMap.Point(116.404, 39.915);  // 创建点坐标商户坐标
//        var pointB = new BMap.Point(106.581515,29.615467);  // 创建点坐标
//        alert('从大渡口区到江北区的距离是：'+(map.getDistance(pointA,pointB)).toFixed(2)+' 米。');  //获取两点距离,保留小数点后两位
        }

</script>
</body>
</html>