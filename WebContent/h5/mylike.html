<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no,target-densitydpi=device-densitydpi" />
    <title>个人中心</title>
    <link rel="stylesheet" href="css/common.css">

    <script type="text/javascript" src="js/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="js/self-menu.js"></script>
    <script src="./js/common.js"></script>
    <script src="./js/jquery-jtemplates.js"></script>
    <script src="./js/pageCommon.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=1.4"></script>
    <script type="text/javascript" src="js/quo.js"></script>
</head>
<style>
</style>
<script>
    var optionDom;
    $(function(){
        if(!localStorage.userinfo){
            window.location.href = "bind-mine.html";
        }
        var userInfo = JSON.parse(localStorage.userinfo);
        /*页面加载时创建一次jtemplate模板，此后都是给模板赋值*/
        (function createTemplate(){
            // 附上模板
            $("#followlist").setTemplateElement("template");

        })();
        var userPosition ;
        if(localStorage.userPosition){
            userPosition = localStorage.userPosition;
            /*接口调用*/
            po('user','getfollowlist',{"UserID":userInfo.UserID,"UserPosition":userPosition,"SellerID":""},"getfollowlistcallback");
        }else{
            /*获取位置信息*/
            var geolocation = new BMap.Geolocation();
            var userPosition = "116.404|39.915";
            geolocation.getCurrentPosition(function(r){
                if(this.getStatus() == BMAP_STATUS_SUCCESS){
                    //alert('您的位置：'+r.point.lng+','+r.point.lat);
                    userPosition = r.point.lng+"|"+r.point.lat;
                    localStorage.UserPosition = userPosition;
                }
                else {
                    if(localStorage.userPosition){
                        userPosition = "116.404|39.915";
                    }
                }
                /*接口调用*/
                po('user','getfollowlist',{"UserID":userInfo.UserID,"UserPosition":userPosition,"SellerID":""},"getfollowlistcallback");
            },{enableHighAccuracy: true});
        }

        /*长按事件*/
        $$(document).on("hold","#followlist>li",function(){
            //TODO弹出框是否确定删除
            optionDom = $$(this);
            var choose = confirm("确定要删除？");
            //根据返回结果判断：否不操作，是则删除
            if(choose){
                var act="cancel";
                var sellerId = $$(this).attr("seller");
                var data={
                    "SellerID":sellerId,
                    "UserID":userInfo.UserID,
                    "Act": act
                };
                po('seller','follow',data,"getattentioncallback");

            }
        });

    });
    /*关注和取消的回调函数*/
    function getattentioncallback(d){
        if(d.rd.succ){
            optionDom.remove();
        }else{
            alert(d.rd.msg);
        }
    }
    //获取关注列表回调函数
    function getfollowlistcallback(d){
        if(d.rd.succ){
            var fl = d.rd.data.followlist;
            for(var j = 0;j<fl.length;j++){
               /* if(fl[j]["SellerName"].length>5){
                    fl[j]["SellerName"] = fl[j]["SellerName"].substr(0,4)+"...";
                }*/
                //判断商家是否已认证，并将json改为相应的class
                if(fl[j]["AuthFlag"]=="Y"){
                    fl[j]["AuthFlag"]="已认证";
                }

                if(!fl[j]["SellerDistance"]){
                    fl[j]["SellerDistance"] = "--"
                }
                if(!fl[j]["R5"]){
                    fl[j]["R5"] = "--"
                }
                if(!fl[j]["R4"]){
                    fl[j]["R4"] = "--"
                }
                var img = new Image();
                img.src = fl[j]["PicUrl"];
                if (img.fileSize > 0 || (img.width > 0 && img.height > 0)) {

                }else{
                    fl[j]["PicUrl"]="img/store.png";
                }
            }
            //以下采用jtemplates的方式进行模板的拼接
            // 给模板加载数据
            $("#followlist").processTemplate(d.rd.data.followlist);	/*d.rd.data.sellerlist*/
        }else{
            alert(d.rd.msg);
        }
    }
</script>
<body>

<header>
    个人中心
</header>
<div class="self-menu" >
    <div id="menu" class="menu" style="left: -70%">
        <ul>
            <li class="first-item " style="margin-left: 1%"><a href="selfzoom.html">我的中心</a></li>
            <li><a href="my-info.html">个人信息</a></li>
            <li class="right-border0" style="margin-right: 1%"><a href="myOrderList.html">订单信息</a></li>
            <li class="margin-left" style="margin-left: 1%"><a href="myactivity.html">我的活动</a></li>
            <li><a href="mysave.html">我的收藏</a></li>
            <li class="right-border0 selected" style="margin-right: 1%"><a href="#">我的关注</a></li>
        </ul>
    </div>
    <div class="move-left" id="moveleft"><a ></a></div>
    <div class="move-right" id="moveright"><a ></a></div>
</div>
<main class="mysave">
    <ul id="followlist">
        <textarea id="template" style="display:none">
            {#foreach $T as record}
        <li class="odd-item" seller="{$T.record.SellerID}">
            <span>
                <a href="view-shop.html?id={$T.record.SellerID}" style='border-radius: 50%;background: url("{$T.record.PicUrl}");background-position: center;background-size: cover'>
                    <!--<img width="100%" src="img/save-shop.png">-->
                    <div class="info" style="border-radius: 50%">
                        <span class="info-txt">
                        <h1 class="title">{$T.record.ShotOrgName}</h1>
                        <h4 class="content1">距离：{$T.record.SellerDistance}</h4>
                        <h4 class="content2">类型：{$T.record.R5}</h4>
                        <h4 class="content3">等级：{$T.record.R4}</h4>
                    </span>
                        <div style="position: absolute;width:15%;height: 15%;background: url('icons/new.png');background-position: center;background-size: cover;right: 10%;top: 10%;z-index: 8"></div>
                    </div>
                </a>
            </span>
        </li>
            {#/for}

        </textarea>
    </ul>
</main>
<footer>
    <ul>
        <li class="side-item"></li>
        <li>
            <a  href="activities.html">
                <span class="button-icon activity-icon"></span>
            </a>
        </li>
        <li>
            <a  href="busines.html">
                <span class="button-icon business-icon"></span>
            </a>
        </li>
        <li>
            <a class="selected"  href="selfzoom.html">
                <span class="button-icon selfzoom-icon"></span>
            </a>
        </li>
        <li class="side-item"></li>
    </ul>
</footer>
<script>
    $(function () {
        $(window).scroll(function () {
            $("footer").animate({bottom: "0"}, "fast");
        });
    });
</script>
</body>
</html>