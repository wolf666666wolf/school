<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no,target-densitydpi=device-densitydpi" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="format-detection" content="email=no" />
    <title>商品信息</title>
    <link rel="stylesheet" href="css/common.css">
    <script type="text/javascript" src="js/jquery-1.11.1.min.js"></script>
    <script src="./js/common.js"></script>
    <script src="./js/jquery-jtemplates.js"></script>
    <script src="./js/pageCommon.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=1.4"></script>
</head>

<style>

</style>
<script>
    var canBookStyle = ""
    $(function(){
        //页面加载的一些处理
        if(localStorage.userinfo==undefined){
            window.location.href = "bind-mine.html";
        }
        var userInfo = JSON.parse(localStorage.userinfo);
        if(localStorage.sellerInfo){
            sellerInfo = JSON.parse(localStorage.sellerInfo);
            if(sellerInfo.AuthFlag!="Y"){
                canBookStyle = "visibility:hidden;"
            }
        }else{
            window.location.href("busines.html");
        }
        /*alert(getParameter("id"))*/
        var prdInfo = JSON.parse("{}")
        var prdid;
        if(getParameter("id")){
            prdid = getParameter("id");
            prdInfo.PrdID = prdid;
            localStorage.prdInfo = JSON.stringify(prdInfo) ;
            //alert(localStorage.sellerInfo);
        }else  if(localStorage.prdInfo){
            prdInfo = JSON.parse(localStorage.prdInfo);
        }else{
            window.location.href="view-goods.html";
        }

        var userPosition ;
        if(localStorage.userPosition){
            userPosition = localStorage.userPosition;
            //调用接口
            po('product','getprd',{"PrdID":prdInfo.PrdID,"UserPosition":userPosition,"UserID":userInfo.UserID},"getprdcallback");
        }else{
            /*获取位置信息*/
            var geolocation = new BMap.Geolocation();
            var userPosition = "116.404|39.915";
            geolocation.getCurrentPosition(function(r){
                if(this.getStatus() == BMAP_STATUS_SUCCESS){
                    //alert('您的位置：'+r.point.lng+','+r.point.lat);
                    userPosition = r.point.lng+"|"+r.point.lat;
                    localStorage.UserPosition = userPosition;
                }
                else {
                    if(localStorage.userPosition){
                        userPosition = "116.404|39.915";
                    }
                }
                //调用接口
                po('product','getprd',{"PrdID":prdInfo.PrdID,"UserPosition":userPosition,"UserID":userInfo.UserID},"getprdcallback");
            },{enableHighAccuracy: true});
        }


        /*收藏和取消关注的按钮*/
        $(document).on("click","#save",function(){
            var act=$(this).attr("act");
            var data={
                "PrdID":prdInfo.PrdID,
                "UserID":userInfo.UserID,
                "Act": act
            };
//            alert(prdInfo.PrdID+"  "+userInfo.UserID)
            po('product','favorite',data,"getfavoritecallback");
        });
    });

    /*收藏和取消的回调函数*/
    function getfavoritecallback(d){
        //alert(JSON.stringify(d))
        d.rd.succ = true;
        if(d.rd.succ){
            alertMsg("#save",d.rd.msg,"10%","-100%","#364e86","0.8em","110%");
            //将图标切换关注
            if($("#save").attr("act")=="add"){
                $("#save").removeClass("add-save");
                $("#save").addClass("cancel-save");
                $("#save").attr("act","cancel")
            }else{
                $("#save").removeClass("cancel-save");
                $("#save").addClass("add-save");
                $("#save").attr("act","add")
            }

        }else{
            alert(d.rd.msg);
        }
    }

    /*获取商品信息的回调函数*/
    function getprdcallback(d)
    {
        //alert(JSON.stringify(d))
        if(d.rd.succ)
        {

           /* d.rd.data.PrdID="xxx";//产品编码
            d.rd.data.PicUrl="img/goodspic.png";//图片地址
            d.rd.data.PrdName="东坡肉";//产品名称
            d.rd.data.MakeDate="xx、xx、xx";//发布时间
            d.rd.data.R3="xxx";//浏览数
            d.rd.data.R4="xx";//预订数
            d.rd.data.MinPrdPrice="xxx";//最低价格
            d.rd.data.MaxPrdPrice="xxx";//最高价格
            d.rd.data.Discount="xx";//折扣
            d.rd.data.Remark="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";//简介
            d.rd.data.ConnStatus = "y"//关联状态y：已关注；n：未关注*/
            if(d.rd.data.ConnStatus=="Y"){
                d.rd.data.ConnStatus="cancel-save";
                d.rd.data.act = "cancel";
            }
            if(d.rd.data.ConnStatus=="N"){
                d.rd.data.ConnStatus="add-save";
                d.rd.data.act = "add";
            }
            if(!d.rd.data.R3){
                d.rd.data.R3="--";
            }
            if(!d.rd.data.R4){
                d.rd.data.R4="--";
            }
            d.rd.data.canBookStyle = canBookStyle;
            //保存到本地缓存
            localStorage.prdInfo = JSON.stringify(d.rd.data);
            //alert(localStorage.sellerInfo );
            // 附上模板
            $("#result1").setTemplateElement("template");
            // 给模板加载数据
            $("#result1").processTemplate(d.rd.data);	/*d.rd.data.sellerlist*/
        }
    }
</script>
<body id="result1">
<textarea id="template" style="display:none">
<header>
    <div class="select-back">
        <a href="view-goods.html">
            <span  class="back-icon"></span><br>
            返回
        </a>
    </div>
    商品信息
    <div class="book" id="bookIco" style="{$T.canBookStyle}">
        <a href="book-good.html?id={$T.PrdID}" class="book-icon2"></a>
    </div>
</header>
<main class="activity-detail" >

    <img src="img/prd.jpg" width="100%" style="display: block;">
    <div class="detail">
        <ul>
            <li class="first"><span>商品名称</span><span class="margin-rightNon">{$T.PrdName}</span></li>
            <li ><span>编号</span><span class="margin-rightNon">{$T.PrdID}</span></li>
            <li class="intro">
                <div class="left-content">
                    <span class="title">简介</span>
                    <span class="txt">
                        {$T.Remark}
                    </span>
                </div>
                <div class="right-btn">
                    <a class="save-icon {$T.ConnStatus}" act="{$T.act}" id="save"></a>
                </div>
            </li>
            <li><span>价格</span><span class="margin-rightNon">{$T.PrdPrice}元</span></li>
            <!--<li><span></span><span style="margin-left: 40px;">{$T.MaxPrdPrice}元 （最高）</span></li>-->
            <li><span>折扣</span><span class="margin-rightNon">{$T.Discount}%</span></li>

            <li>
                <span>发布时间</span>
                <span class="margin-rightNon" >{$T.MakeDate}</span>
            </li>
            <li><span>浏览次数</span><span class="margin-rightNon">{$T.R3}</span></li>
            <li><span>预订数</span><span class="margin-rightNon">{$T.R4}</span></li>

        </ul>
    </div>

</main>
</textarea>
</body>
</html>