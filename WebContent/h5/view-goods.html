<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no,target-densitydpi=device-densitydpi" />
    <title>店铺商品展示</title>
    <link rel="stylesheet" href="css/common.css">
    <script type="text/javascript" src="js/jquery-1.11.1.min.js"></script>
    <script src="./js/common.js"></script>
    <script src="./js/jquery-jtemplates.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=1.4"></script>
    <script src="./js/pageCommon.js"></script>
</head>
<style>


</style>
<script>

    $(function(){
        $("#goodsSearchHeader").hide();//隐藏头部查询栏部分
        $("#changeSearch").click(function(){
            $("#goodsSearchHeader").show();
            $("#goodsHeader").hide();
        });
        // 附上模板
        $("#prdlist").setTemplateElement("template");


        if(localStorage.userinfo.trim()=="undefined"){
            window.location.href = "bind-mine.html";
        }
        userInfo = JSON.parse(localStorage.userinfo);
        if(getParameter("id") && getParameter("id")!=""){
            var sellerInfo = JSON.parse("{}");
            var sellerId = getParameter("id");
            sellerInfo.SellerID = sellerId;
            po('seller','getseller',{"SellerID":sellerInfo.SellerID,"UserPosition":userPosition,"UserID":userInfo.UserID},"getsellercallback");
        }  else if(localStorage.sellerInfo){
            sellerInfo = JSON.parse(localStorage.sellerInfo);
        }else {
            window.location.href("busines.html");
        }
        keywords = "";
        var userPosition ;
        if(localStorage.userPosition){
            userPosition = localStorage.userPosition;
            /*接口调用*/
            var data={
                KeyWords:keywords,
                SellerID:sellerInfo.SellerID,
                "UserPosition":userPosition
            };
            //调用接口
            po('product','getprdlist',data,"getprdlistcallback");
        }else{
            /*获取位置信息*/
            var geolocation = new BMap.Geolocation();
            var userPosition = "116.404|39.915";
            geolocation.getCurrentPosition(function(r){
                if(this.getStatus() == BMAP_STATUS_SUCCESS){
                    //alert('您的位置：'+r.point.lng+','+r.point.lat);
                    userPosition = r.point.lng+"|"+r.point.lat;
                    localStorage.UserPosition = userPosition;
                }
                else {
                    if(localStorage.userPosition){
                        userPosition = "116.404|39.915";
                    }
                }
                /*接口调用*/
                var data={
                    KeyWords:keywords,
                    SellerID:sellerInfo.SellerID,
                    "UserPosition":userPosition
                };
                //调用接口
                po('product','getprdlist',data,"getprdlistcallback");
            },{enableHighAccuracy: true});
        }



        $("#search").click(function(){
            keywords = $("#keyWords").val().trim();//保存关键字
            if(keywords==""){
                return;
            }
            var data={
                "KeyWords":keywords,
                "SellerID":sellerInfo.SellerID,
                "UserPosition":userPosition
            };
            //调用接口，a=seller,o=getsellerlist,data就是文档中的d，是要传输的数据，getsellercallback是回调方法
            po('product','getprdlist',data,"getprdlistcallback");
        });
    });
    /*商品列表回调函数*/
    function getprdlistcallback(d){
        //alert(JSON.stringify(d));
        if(d.rd.succ){
            var ShotOrgName = d.rd.data.ShotOrgName;
            $("#shopName").html(ShotOrgName);
            var AuthFlag = d.rd.data.AuthFlag;
            var pl = d.rd.data.productlist;
            //alert(JSON.stringify(pl));
            //循环
            for(var i=0;i<pl.length;i++){
                //判断行是奇数还是偶数，并将对应的class写入到json中，供下面绑定模板时候使用
                var style="odd-item";
                if(i%2!=0){
                    style="even-item";
                }
                pl[i]["style"]=style;
                pl[i]["AuthFlag"]="";
                if(AuthFlag!="Y"){
                    pl[i]["AuthFlag"]="visibility:hidden;";
                }

            }
            // 给模板加载数据
            $("#prdlist").processTemplate(pl);	/*d.rd.data.sellerlist*/
        }else{
            alert(d.rd.msg);
        }
    }
    /*获取商家信息的回调函数*/
    function getsellercallback(d)
    {
        //alert(JSON.stringify(d))
        if(d.rd.succ)
        {
            //保存到本地缓存
            localStorage.sellerInfo = JSON.stringify(d.rd.data);
        }
    }
</script>
<body>

<header id="goodsHeader">
    <div class="select-back">
        <a href="busines.html">
            <span class="back-icon"></span><br>
            返回
        </a>
    </div>
    <span id="shopName"></span>
    <div class="search">
        <a id="changeSearch" class="button-icon search-icon"></a>
    </div>
</header>
<header id="goodsSearchHeader">
    <div class="select-back">
        <a href="busines.html">
            <span class="back-icon"></span><br>
            返回
        </a>
    </div>
    <div class="right-search">
        <div class="wrap-up">
            <input id="keyWords" placeholder=" 搜索商品">
        </div>
        <div class="wrap-down"></div>
        <div class="fix-search">
            <div><a id="search" class="button-icon search-icon2"></a></div>
            <div class="fix-search-down"></div>
        </div>

    </div>
</header>
<div class="shop-menu">
    <ul>
        <li  >
            <a href="view-shop.html">详细信息</a>
        </li>
        <li class="selected">
            <a href="#">商品列表</a>
        </li>
    </ul>
</div>
<main class="business" style="padding-bottom: 2em;padding-top: /*13.2em*/108px">
    <ul class="activity-list" id="prdlist">
        <textarea id="template" style="display:none">
            {#foreach $T as record}
        <li class="{$T.record.style}">
            <a href="good-info.html?id={$T.record.PrdID}">
                <div class="left">
                    <div class="left-up">
                        <div class="shop">{$T.record.PrdName}</div>
                    </div>
                    <div class="left-down">
                        <div class="dowm-item1">发布时间：{$T.record.MakeDate}</div>
                        <!--<div class="dowm-item">浏览次数：{$T.record.R3}</div>-->
                        <div class="dowm-item">预订数：{$T.record.R4}</div>
                    </div>
                </div>
                <div class="right book" style="{$T.record.AuthFlag}">
                    <a href="book-good.html?id={$T.record.PrdID}" >
                        <span class="book-icon"></span>下订单
                    </a>
                </div>
                <div class="line" style="{$T.record.AuthFlag}"></div>
            </a>
        </li>
            {#/for}
        </textarea>
    </ul>
</main>


</body>
</html>